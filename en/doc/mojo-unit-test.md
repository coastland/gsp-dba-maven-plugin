gsp-dba-maven-plugin Test
========

## Overview

This section describes the unit test prepared by gsp-dba-maven-plugin.

## Description

* Style to be executed for each MOJO using [harness](https://maven.apache.org/plugin-testing/maven-plugin-testing-harness/) 
* Provides pom.xml for each test case and define parameters in the xml file.
* The test case model consists of:
```
mojo(goal) - Test case (test method) - Target DB(db2, h2, etc..)
```
* The `mvn clean install` does not run any tests.
* [JPA simple verification](#jpa-simple-verification)
    * A verification with simple JPA (Eclpselink) using the entities generated by integration-test.

## SetUp
1. If the RDBMS to be tested has not been installed locally, install it.
    * Notes for all DBs
      * The export/import of this tool executes the commands that are bundled with the DB. Therefore, if Docker is used for installation, the export/import tests cannot be executed.
    * Notes on each DB
      * Oracle 19c
        * When reinstalling, delete the environment variable ORACLE_HOME after deleting the old Oracle, reboot the OS, and then install a new one.
          Reinstallation fails if the reference of ORACLE_HOME is old.
        * When the installer asks you to choose between "Desktop" and "Server", choose "Server".
          If you use "Desktop", some options are not available and you may have to do more work after installation.
        * Do *not* configure for multi-tenancy. Multi-tenant configuration will increase the number of steps required to enable GSP to connect.
        * It is recommended to set the SID to `XE`, because it will be easier to set it later.
        * Immediately after installation, it may be set to listen on an unexpected IP address.
          If connection is not possible from local via TCP/IP, edit `listener.ora` and `tnsnames.ora` to listen on `127.0.0.1`.  
          After editing the file, it is recommended to restart the OS (restarting the service only may not reflect the settings properly).
      * SQLServer
        * Install Microsoft SQL Server Management Studio (a.k.a. SSMS) as it is useful for configuration.
      * MySQL
        * Testing with Series 5.
        * The charset should be `utf8mb4`. (MySQL's utf8 has some unicode characters that cannot be used.)
          * Edit `C:\blur1}ProgramData\MySQL Server 5.7\my.ini` and set `character-set-server=utf8mb4`.
1. Modify [jdbc_test.properties](../../src/test/resources/jdbc_test.properties) and DB connections.
    * Since the test is executed using this connection information, modify jdbc_test.properties or match by changing DB.
      * All DBs
        * Create or configure the following
          * adminUser
          * DB or schema (which is required depends on the type of RDBMS). The name is generally unified as `gsptest`.
            However, in the case of Oracle, it is not necessary to create it since it is created when the test is run.
        * The following may not be necessary.
          * General user.
            However, DB2 requires the DB user to be prepared as an OS user, so be prepared.
          * The schema to use for import/export tests. It is generally unified with the name `gspanother`. If not, it is created at test execution time.
      * DB2
        * How to deal with DB2 startup failures
          * Make the login user of the OS belong to the `DB2ADMINS` group of the OS.
        * DB creation
          If it has not been created yet, create it as follows.
          ```
          db2 => CREATE DATABASE gsptest
          ```
        * Authorization
          `db2admin` does not have GRANT permissions by default, so grant it.
          ```
          CONNECT TO gsptest
          GRANT DBADM ON DATABASE TO USER db2admin
          ```
        * User
          DB2 uses the OS user, so prepare a user for the OS.
          In the standard of this project, the ID is `gsptest` and the password is `Gsptest123`. The user should belong to the `DB2ADMINS` group of the OS.
      * SQLServer
        * Enable sa user since it is disabled by default. it is easy to change the setting using SSMS.
        * TCP is not enabled by default, so enable it.
          Referenceï¼šhttps://qiita.com/sugasaki/items/a95c2495085e32851707
1. In [pom.xml](../../pom.xml) to define dependencies for third-party JDBC drivers
    * The version of the JDBC driver to be used can be found at https://github.com/nablarch/nablarch-parent/blob/master/pom.xml. The JDBC driver used in the Nablarch tests is listed there.
    * For the relationship between Oracle's JDBC driver and the Java version, see https://www.oracle.com/database/technologies/faq-jdbc.html.
    * As of 2020, the latest drivers for RDBMSs supported by GSP exist in Maven Central.
      If you need to test with an older driver, get the JDBC driver jar and put it in your local repository, and define the dependencies in pom.xml.
      * Notes on testing with older drivers
        * PostgreSQL
          * If you use a version prior to 42.3.0, the result of Entity generation may differ due to a jdbc driver bug.  
            Specifically, annotations with the attribute `precision = 131089` are generated in  [View2.java](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo/GenerateEntity_test/view/postgresql/expected/output/jp/co/tis/gsptest/entity/entity/View2.java).
            See https://github.com/pgjdbc/pgjdbc/issues/2188 for details.
            ```java
            @Column(name = "test2", precision = 131089, nullable = true, unique = false)
            public BigDecimal getTest2() {
            ```
        * SQLServer
          * If you use a version prior to 10.2, you do not need to set `encrypt=false;` for `sqlserver.url` in [jdbc_test.properties](../../src/test/resources/jdbc_test.properties).
      * Local installation example (change the version accordingly)
        ```shell
        mvn install:install-file -Dfile=ojdbc6.jar -DgroupId=com.oracle -DartifactId=ojdbc6 -Dversion=11.2.0.2.0 -Dpackaging=jar
        mvn install:install-file -Dfile=db2jcc4.jar -DgroupId=com.ibm -DartifactId=db2jcc4 -Dversion=9.7.200.358 -Dpackaging=jar
        mvn install:install-file -Dfile=sqljdbc4.jar -DgroupId=com.microsoft -DartifactId=sqljdbc4 -Dversion=4.0 -Dpackaging=jar
        ```
      * Example of dependency definition to be added to pom.xml
        ```xml:pom.xml
        <dependency>
            <groupId>com.ibm</groupId>
            <artifactId>db2jcc4</artifactId>
            <version>9.7.200.358</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.oracle</groupId>
            <artifactId>ojdbc6</artifactId>
            <version>11.2.0.2.0</version>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>com.microsoft</groupId>
            <artifactId>sqljdbc4</artifactId>
            <version>4.0</version>
            <scope>test</scope>
        </dependency>
        ```

## Usage
```
mvn -P all_test clean integration-test site
```
It takes about 30 minutes to complete.  
Mojo and simple JPA tests are executed.

## TestCase Level 1

1. See [Test resource](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo).
    * Each Mojo has a folder.
    * Mojo has a folder for each test case.
    * A DB name folder is present in the test case folder.
    * The file pom.xml is in the DB name folder.
    * pom.xml specifies the parameters needed for the goal.
2. [Test class and method](../../src/test/java/jp/co/tis/gsp/tools/dba/mojo/GenerateDdlMojoTest.java#L33)
    * `@TestDBPattern(testCase=..., testDb=...)` controls which test cases and which DBs are tested. <br />
        * `testCase`      Which is the test case folder?
        * `testDb`       Which DB folder should be implemented?
    * The above annotation information is read, `mojoTestFixtureList` is generated and passed around.
```java
	@Test
	@TestDBPattern(testCase = "type", testDb = { TestDB.oracle, TestDB.postgresql, TestDB.db2, TestDB.h2,
			TestDB.sqlserver, TestDB.mysql })
	public void testType() throws Exception {

		// MojoTestFixtureList is a DB list of the information needed to run the test, prepared by reading the @TestDBPattern information.
		// In short, the specified DB loop is passed.
		for (MojoTestFixture mf : mojoTestFixtureList) {

/** Preparation phase */
			// File object of the Mojo folder/test case folder/DB folder/pom.xml
			// Define the parameters required for goal execution in pom.xml.
			File pom = new File(getTestCaseDBPath(mf) + "/pom.xml");

/** Goal execution phase */
			// Specify pom.xml, goal name and DB name. This is a standard code.
			GenerateDdlMojo mojo = this.lookupConfiguredMojo(pom, GENERATE_DDL, mf.testDb);
			mojo.execute();

/** Test result verification phase */
			// Verification. Mojo prepares the expected file in advance and matches it with the file that is output.
			
			// Files output after execution
			String actualPath = mojo.outputDirectory.getAbsolutePath();
			Entry actualFiles = DirUtil.collectEntry(actualPath);
			
			// Files of expected value that are prepared
			Entry expectedFiles = DirUtil.collectEntry(getExpectedPath(mf) + FS + "ddl");
			
			// Match
			assertThat("TestDb:" + mf.testDb, actualFiles.equals(expectedFiles), is(true));

		}

```

## TestCase Level 2

* Execute with only a certain DB.
    * Specify with [mojoTest.properties](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo/mojoTest.properties)
```shell
testDB=db2
```
* Parameter specification details by pom.xml
    * DB connection parameters, etc. are defined in [Parent pom](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo/testParentPom.xml)
    * A profile is defined in [settings.xml](../../src/test/resources/settings.xml)
    * Flow of solution
        * [jdbc_test.properties](../../src/test/resources/jdbc_test.properties)  
            * [settings.xml](../../src/test/resources/settings.xml)  
                * [testParentPom.xml](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo/testParentPom.xml)  
                    *  pom.xml of each test case. [Example](../../src/test/resources/jp/co/tis/gsp/tools/dba/mojo/ExecuteDdlMojo_test/type/db2/pom.xml)
    
    
## Troubleshoot

* As soon as you run the Mojo test class on Eclipse with Junit, an `AssertionError`-like error may occur and the program may crash.
    * Full clear and full build of the project* will correct the problem.

## JPA simple verification

* In advance, You should have `gsp-dba-maven-plugin` in development installed in your local repository. Run `mvn install -DskipTests` on the branch you are developing.
* Implemented in the `integration-test` phase. Use the plugin maven-invoker-plugin. [it](../../src/it) folder is the main folder.
* DB connection information uses [JDBC_test.properties](../../src/test/resources/jdbc_test.properties) that is used in the Mojo test class.
* Project [simple-jpa-test](../../src/it/simple-jpa-test) is used for each DB and executed.
    1. [edm file of each Db](../../src/it/simple-jpa-test/src/main/resources) of the above mentioned project is input and generate-ddl, execute-ddl and generate-entity are executed.
    1. Execute [Test method](../../src/it/simple-jpa-test/src/test/java/jp/co/tis/gsp/jpatest/AppTest.java#L31).

* When using H2 for DB, [Perform JPA simple verification by setting H2 to legacy mode only when running tests](#perform-jpa-simple-verification-by-setting-h2-to-legacy-mode-only-when-running-tests).
    * Since EclipseLink 2.5.0, the JPA implementation used for JPA simple verification, does not support 2.x series of H2, [test](https://github.com/coastland/gsp-dba-maven-plugin/blob/4.5.0/pom.xml#L580) fails.
        * Hibernate 6 series supports H2 2.1.214, but it cannot be used because it supports Jakarta EE 9.
            * Because gsp-dba-maven-plugin does not support Jakarta EE 9.
        * EclipseLink 3.0 may support 2.x series of H2, but since it also supports Jakarta EE 9, it cannot be used with gsp-dba-maven-plugin anyway.

    * The purpose of JPA simple verification is to confirm that the annotation format set in the entity generated by gsp-dba-maven-plugin conforms to JPA specifications.
        * Since the annotation format does not depend on the DB product or DB version, there is no problem in checking in H2 legacy mode to verify whether it conforms to the JPA specifications.
            * Due to [compatibility features of H2](http://www.h2database.com/html/features.html#compatibility), it can be operated as version 1.x series by setting the mode to legacy mode.
        * The JPA specification basically allows annotations to be set without depending on the DB product or DB version.

### Perform JPA simple verification by setting H2 to legacy mode only when running tests

Run [each goals](https://github.com/coastland/gsp-dba-maven-plugin/blob/4.5.0/pom.xml#L575-L580) run by `maven-invoker-plugin` directly with the mvn command.

Start Command Prompt (Windows) and execute the following.
For Linux, replace the caret (^) with a backslash (\\).

If you use a proxy environment, add the proxy settings to [settings.xml](../../src/test/resources/settings.xml) specified in the command.

1. Go to `src/it/simple-jpa-test`
1. Run the command below
    ```
    mvn -P h2 -s ../../test/resources/settings.xml clean ^
    gsp-dba:generate-ddl gsp-dba:execute-ddl gsp-dba:generate-entity ^
    -Dh2.jdbcDriver=org.h2.Driver ^
    -Dgsp.version=4.7.0 ^
    -Dh2.user=gsptest ^
    -Dh2.password=gsptest ^
    -Dh2.adminUser=sa ^
    -Dh2.url=jdbc:h2:./target/gsp_test
    ```
    * The goals (generate-ddl, execute-ddl and generate-entity) of gsp-dba-maven-plugin are executed on H2 without specifying mode.
1. Run the command below
    ```
    mvn -P h2 -s ../../test/resources/settings.xml test ^
    -Dh2.jdbcDriver=org.h2.Driver ^
    -Dgsp.version=4.7.0 ^
    -Dh2.user=gsptest ^
    -Dh2.password=gsptest ^
    -Dh2.adminUser=sa ^
    -Dh2.url="jdbc:h2:./target/gsp_test;MODE=LEGACY"
    ```
    * The [test](../../src/it/simple-jpa-test/src/test/java/jp/co/tis/gsp/jpatest/AppTest.java#L31) is run specifying H2's legacy mode.